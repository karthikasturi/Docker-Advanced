# Full Stack Monitoring Setup: Web App + Database + Observability

This guide explains how to:

- Deploy a basic web application with a database using Docker Compose
- Configure Prometheus and Loki for metrics and logs
- Create a Grafana dashboard that unifies logs and metrics for root cause analysis (RCA)

---

## Prerequisites

- Docker and Docker Compose installed
- Internet access to pull images
- Default Docker log driver should be `json-file`

---

## Directory Structure

```bash
observability-stack/
├── docker-compose.yml
├── prometheus.yml
├── loki-config.yml
└── promtail-config.yml
```

---

## Step 1: Create `docker-compose.yml`

```yaml
services:

  web:
    image: nginx:alpine
    container_name: web
    ports:
      - "8080:80"
    restart: unless-stopped
    labels:
      job: webapp

  db:
    image: postgres:13
    container_name: db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: appdb
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/loki-config.yml
    volumes:
      - ./loki-data:/loki
      - ./loki-config.yml:/etc/loki/loki-config.yml
    restart: unless-stopped

  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail
    volumes:
      - ./promtail-config.yml:/etc/promtail/promtail-config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/var/log
      - /etc/machine-id:/etc/machine-id:ro
      - /etc/hostname:/etc/hostname:ro
    command: -config.file=/etc/promtail/promtail-config.yml
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    restart: unless-stopped

volumes:
  pgdata:
```

---

## Step 2: `prometheus.yml`

```yaml
global:
  scrape_interval: 5s

scrape_configs:
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
```

---

## Step 3: `loki-config.yml`

```yaml
# Simplified Loki configuration for a single-binary demo.
# All data is stored locally on the filesystem.

auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096

# Configures the ingester component, which writes incoming log data.
ingester:
  wal:
    enabled: true
    dir: /loki/wal
  lifecycler:
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
  chunk_idle_period: 5m
  max_chunk_age: 1h

# Defines the storage schema and backend.
schema_config:
  configs:
    - from: 2024-01-01
      store: boltdb-shipper
      object_store: filesystem
      schema: v13
      index:
        prefix: index_
        period: 24h

# Configures where Loki stores its data (indexes and chunks).
storage_config:
  boltdb_shipper:
    active_index_directory: /loki/index
    cache_location: /loki/boltdb-cache
  filesystem:
    directory: /loki/chunks

# Explicitly configure the compactor's working directory.
compactor:
  working_directory: /loki/compactor
  shared_store: filesystem

# Manages retention settings for stored logs.
table_manager:
  retention_deletes_enabled: true
  retention_period: 168h # Retain logs for 7 days.

# Sets operational limits.
limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h

# Default query lookback period.
chunk_store_config:
  max_look_back_period: 0s
```

---

## Step 4: `promtail-config.yml`

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: container-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: container-logs
          __path__: /var/lib/docker/containers/*/*.log
```

---

## Step 5: Launch the Stack

```bash
docker compose up -d
```

---

## Step 6: Access Tools

| Tool       | URL                   | Default Login |
| ---------- | --------------------- | ------------- |
| Web App    | http://localhost:8080 | N/A           |
| Grafana    | http://localhost:3000 | admin / admin |
| Prometheus | http://localhost:9090 | N/A           |
| Loki       | http://localhost:3100 | N/A           |

---

## Step 7: Grafana Setup

### Add Data Sources:

- Prometheus: `http://prometheus:9090`
- Loki: `http://loki:3100`

### Create a Unified Dashboard:

Include panels for:

- CPU and Memory usage (from cAdvisor)

- DB uptime or IO (from cAdvisor)

- Web traffic or container restarts

- Log search panel from Loki:
  
  - Example LogQL:
    
    ```logql
    {job="container-logs"} |= "GET"
    ```

---

## RCA Readiness Dashboard

Your Grafana dashboard should include:

- Metric alerts (CPU/memory thresholds)
- Log stream panel (by container name)
- Time range selector for correlation
- Status of services and DB

---

## Clean Up

```bash
docker compose down -v
```

---
