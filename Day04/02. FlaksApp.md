# Flask + PostgreSQL + CI/CD with Trivy Security Scan

A simple Flask application that connects to a PostgreSQL database, built and deployed using Jenkins and GitHub Actions, with container security scanning using Trivy.

---

## Project Directory Structure

flask-pg-app/
├── app.py
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
├── Jenkinsfile
├── .github/
│ └── workflows/
│ └── docker.yml

---

## `app.py`

```python
from flask import Flask, request, jsonify
import psycopg2
import os

app = Flask(__name__)

DB_HOST = os.environ.get("DB_HOST", "localhost")
DB_NAME = os.environ.get("DB_NAME", "flaskdb")
DB_USER = os.environ.get("DB_USER", "flaskuser")
DB_PASS = os.environ.get("DB_PASS", "flaskpass")

def get_connection():
    return psycopg2.connect(
        host=DB_HOST,
        database=DB_NAME,
        user=DB_USER,
        password=DB_PASS
    )

def init_db():
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS messages (
            id SERIAL PRIMARY KEY,
            text TEXT NOT NULL
        )
    """)
    conn.commit()
    cur.close()
    conn.close()

@app.route('/')
def hello():
    return "Flask App with PostgreSQL!"

@app.route('/add', methods=['POST'])
def add_message():
    data = request.get_json()
    msg = data.get('text', '')
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("INSERT INTO messages (text) VALUES (%s)", (msg,))
    conn.commit()
    cur.close()
    conn.close()
    return jsonify({"message": "Inserted"}), 201

@app.route('/list', methods=['GET'])
def list_messages():
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("SELECT * FROM messages")
    rows = cur.fetchall()
    cur.close()
    conn.close()
    return jsonify(rows)

if __name__ == '__main__':
    init_db()
    app.run(host='0.0.0.0', port=5000)
```

## requirements.txt

```text
Flask==2.3.3
psycopg2-binary==2.9.9
```

## Dockerfile (Multi-stage Build)

```Dockerfile
# Stage 1: Builder

FROM python:3.11-slim AS builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --user -r requirements.txt

# Stage 2: Runtime

FROM python:3.11-slim
WORKDIR /app
COPY --from=builder /root/.local /root/.local
ENV PATH=/root/.local/bin:$PATH
COPY . .
EXPOSE 5000
CMD ["python", "app.py"]
```

## docker-compose.yml (for Local Dev)

## Jenkinsfile

```groovy
pipeline {
  agent any

  environment {
    IMAGE_NAME = 'yourdockerhubusername/flask-pg-app'
    DB_HOST = 'host.docker.internal'
    DB_NAME = 'flaskdb'
    DB_USER = 'flaskuser'
    DB_PASS = 'flaskpass'
  }

  stages {
    stage('Checkout') {
      steps {
        git 'https://github.com/yourusername/flask-pg-app.git'
      }
    }

    stage('Start PostgreSQL') {
      steps {
        sh '''
          docker run -d --name pg-test \
            -e POSTGRES_DB=$DB_NAME \
            -e POSTGRES_USER=$DB_USER \
            -e POSTGRES_PASSWORD=$DB_PASS \
            -p 5432:5432 \
            postgres:13

          sleep 10
        '''
      }
    }

    stage('Build Docker Image') {
      steps {
        sh 'docker build -t $IMAGE_NAME .'
      }
    }

    stage('Run Tests') {
      steps {
        sh '''
          docker run -d --name flask-test-app \
            -e DB_HOST=$DB_HOST \
            -e DB_NAME=$DB_NAME \
            -e DB_USER=$DB_USER \
            -e DB_PASS=$DB_PASS \
            -p 5000:5000 $IMAGE_NAME

          sleep 10
          curl -X POST http://localhost:5000/add -H "Content-Type: application/json" -d '{"text": "CI/CD Jenkins Test"}'
          curl http://localhost:5000/list
          docker stop flask-test-app
        '''
      }
    }

    stage('Install Trivy and Scan Image') {
      steps {
        sh '''
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          /usr/local/bin/trivy image --exit-code 1 --severity CRITICAL,HIGH $IMAGE_NAME
        '''
      }
    }

    stage('Push to Docker Hub') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub-creds',
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          sh '''
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker push $IMAGE_NAME
          '''
        }
      }
    }
  }

  post {
    always {
      echo 'Cleaning up containers...'
      sh 'docker rm -f flask-test-app || true'
      sh 'docker rm -f pg-test || true'
    }
  }
}
```

## .github/workflows/docker.yml

```yaml
name: Build and Push Docker Image

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: yourdockerhubusername/flask-pg-app
      DB_HOST: localhost
      DB_NAME: flaskdb
      DB_USER: flaskuser
      DB_PASS: flaskpass

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_DB: flaskdb
          POSTGRES_USER: flaskuser
          POSTGRES_PASSWORD: flaskpass
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready" 
          --health-interval=10s 
          --health-timeout=5s 
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Build Docker Image
        run: docker build -t $IMAGE_NAME .

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install wget -y
          wget https://github.com/aquasecurity/trivy/releases/download/v0.18.3/trivy_0.18.3_Linux-64bit.deb
          sudo dpkg -i trivy_0.18.3_Linux-64bit.deb

      - name: Scan Docker Image with Trivy
        run: trivy image --exit-code 1 --severity CRITICAL,HIGH $IMAGE_NAME

      - name: Run container and test endpoints
        run: |
          docker run -d --name flask-app \
            -e DB_HOST=host.docker.internal \
            -e DB_NAME=flaskdb \
            -e DB_USER=flaskuser \
            -e DB_PASS=flaskpass \
            -p 5000:5000 $IMAGE_NAME

          sleep 10
          curl -X POST http://localhost:5000/add -H "Content-Type: application/json" -d '{"text": "CI/CD test"}'
          curl http://localhost:5000/list
          docker stop flask-app

      - name: Push Docker Image
        run: docker push $IMAGE_NAME
```

## GitHub Actions Secrets Required

Add the following secrets to your repository:

- `DOCKER_USER` – your Docker Hub username

- `DOCKER_PASS` – your Docker Hub password or token
