# Docker Security Demos & Lab Exercises

Day 1:
---

## 00. Container Basics : Namespaces

### 1. Start a Container

```bash
docker run -dit --name ns-demo alpine sh
```

### if running docker desktop

```bash
docker exec ns-demo ls -l /proc/1/ns/
```

**Sample Output:**  

```bash
ipc  -> ipc:[4026532449]  
mnt  -> mnt:[4026532450]  
net  -> net:[4026532451]  
pid  -> pid:[4026532452]  
user -> user:[4026531837]  
uts  -> uts:[4026532453]
```

Each file is a symbolic link to a **namespace instance** the container is using.

### 2. Get the Container’s Host PID (If running docker-ce)

```bash
docker inspect -f '{{.State.Pid}}' ns-demo
```

**Expected Output:**

- 4521
  This is the PID of the container's main process on the host

### 3. Inspect Namespace Bindings (If running docker-ce)

```bash
ls -l /proc/4521/ns/
```

**Sample Output:**  

```bash
ipc  -> ipc:[4026532449]  
mnt  -> mnt:[4026532450]  
net  -> net:[4026532451]  
pid  -> pid:[4026532452]  
user -> user:[4026531837]  
uts  -> uts:[4026532453]
```

Each file is a symbolic link to a **namespace instance** the container is using.

### 4. Compare With Host's Namespaces

```bash
ls -l /proc/$$/ns/
```

This lists your current shell’s namespaces. The inode numbers will differ, proving that **namespaces are isolated**.

### 5. Enter Container Namespaces (Optional)

Use *nsenter* to enter the container's namespaces from the host:

```bash
sudo nsenter -t 4521 -a
```

Now you're inside the container’s namespace **without using Docker CLI**.

Enter only the network namespace:

```bash
sudo nsenter -t 4521 --net ip a
```

### Explanation of Common Namespaces

| Namespace | Isolates        | Verification Example              |
| --------- | --------------- | --------------------------------- |
| `pid`     | Process tree    | `ps aux` inside vs outside        |
| `net`     | Network stack   | `ip a` → different interfaces/IP  |
| `mnt`     | Mount points    | `mount` or `df -h`                |
| `uts`     | Hostname/domain | `hostname` inside vs outside      |
| `ipc`     | Shared memory   | `ipcs`                            |
| `user`    | User IDs        | `id` → different UID/GID mappings |

## 00. Container Basics: Cgroups

### 1. Run a Container with Limited Memory

```bash
docker run -dit --name memtest --memory=100m alpine sh
```

This container will have **100MB memory limit**.

### 2. Inside the Container: Try to Exhaust Memory

```bash
docker exec -it memtest sh
```

**Inside container:**

```bash
# Try to allocate memory
dd if=/dev/zero of=/dev/null bs=1M count=200
```

It should get **killed by the kernel** due to memory limit.

### 3. Observe Cgroups in Host Filesystem

```bash
docker inspect -f '{{.State.Pid}}' memtest
```

Assume PID is 5432. Then:

```bash
cat /proc/5432/cgroup
```

**Sample output:**

```ruby
12:memory:/docker/<container-id>
11:cpu,cpuacct:/docker/<container-id>
...
```

Navigate to the cgroup mount path (may vary by distro):

```bash
cat /sys/fs/cgroup/memory/docker/<container-id>/memory.limit_in_bytes
```

### 4. CPU Limiting (Optional)

Run a CPU-throttled container:

```bash
docker run -dit --name cpu-demo --cpus="0.5" alpine sh
```

Run a CPU-intensive task:

```bash
docker exec -it cpu-demo sh -c "yes > /dev/null"
```

Observe with *top* or *htop*: container will not exceed 50% of one core.

## 00. Container Basics: Union Filesystem (OverlayFS)

OverlayFS combines multiple layers to create a single merged view.

### 1. Create a Container and Modify a File

```bash
docker run -dit --name overlay-demo alpine sh
docker exec overlay-demo sh -c "echo 'MODIFIED' > /etc/os-release"
```

### 2. Identify Image & Container Diff

**Image layers:**

```bash
docker image inspect alpine --format '{{.RootFS.Layers}}'
```

**Container layers:**

```bash
docker inspect -f '{{.GraphDriver.Data}}' overlay-demo
```

Look for fields like:

```ini
UpperDir=/var/lib/docker/overlay2/...
MergedDir=/var/lib/docker/overlay2/...
LowerDir=...
```

These represent:

- **LowerDir**: read-only layers from image.

- **UpperDir**: container’s writable layer.

- **MergedDir**: the union mount that Docker uses.

### 3. Explore the Merged Directory

Find the container's mount path:

```bash
docker inspect -f '{{.GraphDriver.Data.MergedDir}}' overlay-demo
```

```bash
sudo ls -l <MergedDir>/etc/os-release
```

This is the overlay view Docker provides to the container.

You can also explore *UpperDir* to see what changed.

### 4. Run Another Container from the Same Image

```bash
docker run --rm -it alpine sh
```

Check */etc/os-release* – it remains unchanged. This proves **layer immutability**.